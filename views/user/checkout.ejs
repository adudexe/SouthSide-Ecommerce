<%- include('../partials/user/header') %>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  
<style>
    .billing-details-wrap {
        min-height: auto !important;
        height: auto !important;
    }
    
    .address-container {
        max-height: fit-content;
    }
    
    .compact-address {
        font-size: 0.95rem;
    }
    
    .compact-address p {
        line-height: 1.4;
    }
    
    .address-details {
        max-height: fit-content;
    }
</style>

<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="/user/home" class="text-brand">Home</a>
                <span></span> Shop
                <span></span> Checkout
            </div>
        </div>
    </div>

    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row">
                <!-- Order Summary Section (Left Side - 8 columns) -->
                <div class="col-lg-8">
                    <div class="order-summary bg-white p-4 rounded shadow-sm mb-4">
                        <h4 class="mb-4">Order Summary</h4>
                        <div class="order-products mb-4">
                            <% //cart.items.forEach(function(item) { %>
                            <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                                <img src="/uploads/products/<%= //item.product.images[0] %>" alt="Product" class="img-fluid rounded" style="width: 80px; height: 80px; object-fit: cover;">
                                <div class="ms-3 flex-grow-1">
                                    <h6 class="mb-0"><%= //item.product.name %></h6>
                                    <small class="text-muted">Qty: <%= //item.quantity %></small>
                                </div>
                                <div class="ms-3">
                                    <span class="fw-bold">₹<%= //item.price * item.quantity %></span>
                                </div>
                            </div>
                            <% //}); %>
                        </div>

                        <div class="order-totals">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal</span>
                                <span class="fw-bold">₹<%= //subtotal %></span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Shipping</span>
                                <span class="fw-bold">₹<%= //shipping %></span>
                            </div>
                            <div class="d-flex justify-content-between border-top pt-3 mt-3">
                                <span class="h5 mb-0">Total</span>
                                <span class="h5 mb-0 text-brand">₹<%= //total %></span>
                            </div>
                        </div>

                        <!-- Payment Methods -->
                        <div class="payment-methods mt-4 pt-4 border-top">
                            <h5 class="mb-3">Payment Method</h5>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="payment_option" id="cod" value="cod" checked>
                                <label class="form-check-label" for="cod">
                                    Cash on Delivery
                                </label>
                            </div>

                            <!-- Place Order Button -->
                            <button type="button" class="btn btn-primary w-100 mt-3" onclick="placeOrder()">
                                Place Order
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Address Section (Right Side - 4 columns) -->
                <div class="col-lg-4">
                    <div class="billing-details-wrap bg-white p-4 rounded shadow-sm h-100">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="mb-0">Delivery Address</h4>
                            <% if (!userAddress || !userAddress.some(addr => addr.isPrimary)) { %>
                                <button class="btn btn-sm btn-primary" id="add-new-address-btn">Add New</button>
                            <% } %>
                        </div>
                        
                        <div id="address-data" data-address="<%=JSON.stringify(userAddress)%>" class="d-none"></div>
                        
                        <div id="primary-address">
                            <% if (userAddress) { %>
                                <% userAddress.forEach(element => { %>
                                    <% if (element.isPrimary) { %>
                                        <div class="address-details">
                                            <div class="border-bottom pb-3 mb-3">
                                                <p class="mb-1"><strong><%= element.name %></strong></p>
                                                <p class="mb-1"><%= element.street %></p>
                                                <p class="mb-1"><%= element.city %>, <%= element.state %></p>
                                                <p class="mb-1"><%= element.postalCode %></p>
                                                <p class="mb-1">Phone: <%= element.phone %></p>
                                            </div>
                                            <button class="btn btn-outline-primary btn-sm" id="change-address-btn">
                                                Change Address
                                            </button>
                                        </div>
                                    <% } %>
                                <% }) %>
                            <% } else { %>
                                <div class="text-center py-4">
                                    <p class="text-muted mb-3">No delivery address found</p>
                                    <button class="btn btn-primary" id="add-new-address-btn">
                                        Add New Address
                                    </button>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
<!-- Add New Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Address Creation Form -->
                <form id="createAddressForm">
                    <div class="mb-3 fs-2 d-flex justify-content-center">
                        <h2 for="addressNumber" class="form-label" data-address-number="<%= //address.length + 1 %>" id="addressNumber">Address <%= //address.length + 1 %></h2>
                    </div>

                    <!-- Grid Layout for the Form -->
                    <div class="row">
                        <!-- Name -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" placeholder="Enter name" required>
                        </div>
                        <!-- Street -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="street" class="form-label">Street</label>
                            <input type="text" class="form-control" id="street" placeholder="Enter street" required>
                        </div>
                    </div>

                    <div class="row">
                        <!-- City -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="city" class="form-label">City</label>
                            <input type="text" class="form-control" id="city" placeholder="Enter city" required>
                        </div>
                        <!-- State -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="state" class="form-label">State</label>
                            <input type="text" class="form-control" id="state" placeholder="Enter state" required>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Postal Code -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="postalCode" class="form-label">Postal Code</label>
                            <input type="number" class="form-control" id="postalCode" placeholder="Enter postal code" required>
                        </div>
                        <!-- Phone -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" placeholder="Enter phone number" required>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Country -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="country" class="form-label">Country</label>
                            <input type="text" class="form-control" id="country" placeholder="Enter country" required>
                        </div>
                        <!-- Primary Address -->
                        <div class="col-12 col-md-6 mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isPrimary">
                            <label class="form-check-label" for="isPrimary">Set as primary address</label>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button class="btn btn-primary" id="submitButton">Save Address</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Update Address Modal -->
<div class="modal fade" id="updateAddressModal" tabindex="-1" aria-labelledby="updateAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateAddressModalLabel">Update Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Address Update Form -->
                <form id="updateAddressForm">
                    <div class="mb-3 fs-2 d-flex justify-content-center">
                        <h2 for="updateAddressNumber" class="form-label" id="updateAddressNumber">Update Address</h2>
                    </div>

                    <!-- Grid Layout for the Form -->
                    <div class="row">
                        <!-- Name -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="updateName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="updateName" placeholder="Enter name" required>
                        </div>
                        <!-- Street -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="updateStreet" class="form-label">Street</label>
                            <input type="text" class="form-control" id="updateStreet" placeholder="Enter street" required>
                        </div>
                    </div>

                    <div class="row">
                        <!-- City -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="updateCity" class="form-label">City</label>
                            <input type="text" class="form-control" id="updateCity" placeholder="Enter city" required>
                        </div>
                        <!-- State -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="updateState" class="form-label">State</label>
                            <input type="text" class="form-control" id="updateState" placeholder="Enter state" required>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Postal Code -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="updatePostalCode" class="form-label">Postal Code</label>
                            <input type="number" class="form-control" id="updatePostalCode" placeholder="Enter postal code" required>
                        </div>
                        <!-- Phone -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="updatePhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="updatePhone" placeholder="Enter phone number" required>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Country -->
                        <div class="col-12 col-md-6 mb-3">
                            <label for="updateCountry" class="form-label">Country</label>
                            <input type="text" class="form-control" id="updateCountry" placeholder="Enter country" required>
                        </div>
                        <!-- Primary Address -->
                        <div class="col-12 col-md-6 mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="updateIsPrimary">
                            <label class="form-check-label" for="updateIsPrimary">Set as primary address</label>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary" id="updateSubmitButton">Update Address</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Address Modal -->
<div class="modal fade" id="changeAddressModal" tabindex="-1" aria-labelledby="changeAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeAddressModalLabel">Select Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- List of Addresses -->
                <% if (userAddress && userAddress.length > 0) { %>
                <div class="list-group">
                    <% userAddress.forEach(function(address) { %>
                    <button class="list-group-item list-group-item-action" data-address="<%= JSON.stringify(address) %>" id="address_<%= address._id %>">
                        <p><strong>Address <%= address.addressNumber %></strong></p>
                        <p><%= address.street %>, <%= address.city %>, <%= address.state %>, <%= address.postalCode %></p>
                    </button>
                    <!-- <button >update</button> -->
                    <button type="button" class="btn btn-primary mb-4" id="update-address-btn" data-address-id="<%= address._id %>"="">Update Address</button>
                    <% }); %>
                </div>
                <% } else { %>
                <p>No addresses found. Please add an address.</p>
                <% } %>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="add-new-address-btn">Add New Address</button>
            </div>
        </div>
    </div>
</div>

<script src="/javascript/checkoutAddressManagement.js"></script>